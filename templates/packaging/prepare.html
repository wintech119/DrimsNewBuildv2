{% extends 'base.html' %}
{% from 'relief_requests/_status_badge.html' import status_badge %}
{% from 'components/_workflow_progress.html' import render_workflow_progress %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/relief-requests-ui.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/batch-drawer.css') }}">
<style nonce="{{ csp_nonce() }}">
/* Hide Save Draft button from UI while keeping backend functionality intact */
button[name="action"][value="save_draft"] {
    display: none !important;
}

/* CSP-Compliant Utility Classes for Dynamic Styling */
.text-danger { color: #dc3545 !important; }
.text-warning { color: #f57c00 !important; }
.text-body { color: #212529 !important; }
.bg-warning-light { background-color: #fff3cd !important; }
.border-danger { border-color: #dc3545 !important; }
.shadow-danger { box-shadow: 0 0 0 0.2rem rgba(220,53,69,.25) !important; }
.row-hidden { display: none !important; }

.page-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.page-title {
    font-size: 1.75rem;
    font-weight: 600;
    color: #009639;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.page-subtitle {
    font-size: 1rem;
    color: #6c757d;
    margin: 0;
}

.metric-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.metric-card {
    background: #fff;
    border-radius: 0.5rem;
    padding: 1.25rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.metric-icon {
    font-size: 2rem;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
}

.metric-icon.total {
    background: #e3f2fd;
    color: #1976d2;
}

.metric-icon.filled {
    background: #e8f5e9;
    color: #388e3c;
}

.metric-icon.partial {
    background: #fff3e0;
    color: #f57c00;
}

.metric-icon.unallocated {
    background: #fce4ec;
    color: #c2185b;
}

.metric-content {
    flex: 1;
}

.metric-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #212529;
    line-height: 1;
    margin-bottom: 0.25rem;
}

.metric-label {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
}

.search-filter-bar {
    background: #fff;
    border-radius: 0.5rem;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.search-input-wrapper {
    flex: 1;
    min-width: 250px;
    position: relative;
}

.search-input-wrapper i {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
}

.search-input-wrapper input {
    width: 100%;
    padding: 0.5rem 0.75rem 0.5rem 2.5rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    font-size: 0.875rem;
}

.filter-dropdown {
    min-width: 150px;
}

.btn-jump {
    background: #007bff;
    color: #fff;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
    white-space: nowrap;
}

.btn-jump:hover {
    background: #0056b3;
}

.items-table {
    width: 100%;
    background: #fff;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    margin-bottom: 1.5rem;
}

.items-table table {
    width: 100%;
    table-layout: fixed;
}

/* Column Widths for Proper Alignment */
.items-table th:nth-child(1),
.items-table td:nth-child(1) {
    width: 18%;
}

.items-table th:nth-child(2),
.items-table td:nth-child(2) {
    width: 10%;
}

.items-table th:nth-child(3),
.items-table td:nth-child(3) {
    width: 38%;
}

.items-table th:nth-child(4),
.items-table td:nth-child(4) {
    width: 10%;
}

.items-table th:nth-child(5),
.items-table td:nth-child(5) {
    width: 10%;
}

.items-table th:nth-child(6),
.items-table td:nth-child(6) {
    width: 14%;
}

.items-table thead {
    background: #f8f9fa;
}

.items-table th {
    padding: 0.75rem 0.875rem;
    font-weight: 600;
    color: #495057;
    font-size: 0.875rem;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
    vertical-align: middle;
}

.items-table td {
    padding: 0.75rem 0.875rem;
    vertical-align: middle;
    border-bottom: 1px solid #f1f3f5;
    word-wrap: break-word;
}

.items-table tbody tr:hover {
    background: #f8f9fa;
}

.item-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.item-name {
    font-weight: 600;
    color: #212529;
}

.item-sku {
    font-size: 0.8125rem;
    color: #6c757d;
}

.hub-allocation-inline {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    width: 100%;
}

.warehouse-allocation-row {
    display: grid;
    grid-template-columns: 45px 1fr 75px;
    align-items: center;
    gap: 8px;
    padding: 0.25rem 0;
}

.warehouse-allocation-row .warehouse-stock {
    font-size: 0.875rem;
    font-weight: 600;
    color: #212529;
    text-align: right;
    padding-right: 4px;
}

.warehouse-allocation-row .warehouse-name {
    font-size: 0.8125rem;
    color: #495057;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.allocation-input {
    width: 75px;
    padding: 4px 6px;
    box-sizing: border-box;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    text-align: right;
}

.hub-select {
    min-width: 150px;
    max-width: 200px;
}

.qty-input {
    width: 100px;
}

.stock-info {
    font-size: 0.8125rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.status-badge-inline {
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.8125rem;
    font-weight: 500;
    display: inline-block;
}

.status-filled {
    background: #e8f5e9;
    color: #388e3c;
}

.status-partial {
    background: #fff3e0;
    color: #f57c00;
}

.status-unallocated {
    background: #fce4ec;
    color: #c2185b;
}

.status-waiting {
    background: #e3f2fd;
    color: #1976d2;
}

.status-requested {
    background: #f5f5f5;
    color: #616161;
}

.workflow-sidebar-modern {
    background: #fff;
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    overflow: hidden;
}

.workflow-header {
    background: #007bff;
    color: #fff;
    padding: 1rem 1.25rem;
    font-weight: 600;
    font-size: 1rem;
}

.workflow-steps {
    padding: 1.5rem 1.25rem;
}

.workflow-step {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    position: relative;
}

.workflow-step:last-child {
    margin-bottom: 0;
}

.workflow-step:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 12px;
    top: 30px;
    width: 2px;
    height: calc(100% + 1rem);
    background: #e9ecef;
}

.step-icon {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 0.75rem;
    z-index: 1;
    background: #fff;
}

.step-icon.completed {
    background: #28a745;
    color: #fff;
}

.step-icon.active {
    background: #007bff;
    color: #fff;
    border: 3px solid #007bff;
}

.step-icon.pending {
    border: 2px solid #28a745;
    color: #6c757d;
}

.step-content {
    flex: 1;
}

.step-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: #212529;
    margin-bottom: 0.125rem;
}

.step-description {
    font-size: 0.8125rem;
    color: #6c757d;
    margin: 0;
}

.notes-section {
    padding: 1.25rem;
    border-top: 1px solid #dee2e6;
}

.notes-section h6 {
    font-size: 0.875rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.75rem;
}

.notes-textarea {
    width: 100%;
    min-height: 100px;
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    resize: vertical;
}

.action-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-top: 1.5rem;
}

.status-dropdown {
    min-width: 150px;
    font-size: 0.875rem;
}

.status-dropdown.is-invalid {
    border-color: #dc3545;
}

.status-dropdown.is-locked {
    background-color: #e9ecef;
    cursor: not-allowed;
    opacity: 0.85;
}

.status-dropdown:disabled {
    background-color: #e9ecef;
    cursor: not-allowed;
}

.violation-alert {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    max-width: 400px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
</style>
{% endblock %}

{% block title %}Prepare Package - RR-{{ '%06d'|format(relief_request.reliefrqst_id) }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Back Button -->
    <div class="mb-3">
        <a href="{{ url_for('packaging.pending_fulfillment') }}" class="btn-back">
            <i class="bi bi-arrow-left"></i>
            Back
        </a>
    </div>

    <div class="row g-4">
        <!-- Main Content -->
        <div class="col-lg-9 col-xl-9">
            <!-- Page Header -->
            <div class="page-header">
                <div>
                    <h1 class="page-title">
                        <i class="bi bi-box-seam"></i>
                        {% if is_read_only %}View Relief Package{% else %}Prepare Relief Package{% endif %}
                    </h1>
                    <p class="page-subtitle">
                        {{ relief_request.tracking_no if relief_request.tracking_no else 'RR-' + '%06d'|format(relief_request.reliefrqst_id) }} â€¢ {{ relief_request.agency.agency_name if relief_request.agency else 'Unknown Agency' }}
                    </p>
                </div>
            </div>

            {% if is_read_only %}
            <!-- Read-Only Alert Banner -->
            <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
                <i class="bi bi-info-circle-fill me-3 fs-4"></i>
                <div>
                    <strong>View Only Mode</strong><br>
                    This relief request package has already been submitted and is awaiting approval from the Logistics Manager. You cannot make changes at this time.
                </div>
            </div>
            {% endif %}

            <!-- Metric Cards -->
            <div class="metric-cards">
                <div class="metric-card">
                    <div class="metric-icon total">
                        <i class="bi bi-box"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="metric-total">{{ relief_request.items|length }}</div>
                        <div class="metric-label">Total Items</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon filled">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="metric-filled">0</div>
                        <div class="metric-label">Fully Allocated</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon partial">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="metric-partial">0</div>
                        <div class="metric-label">Partial</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon unallocated">
                        <i class="bi bi-exclamation-circle"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="metric-unallocated">{{ relief_request.items|length }}</div>
                        <div class="metric-label">Unallocated</div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Bar -->
            <div class="search-filter-bar">
                <div class="search-input-wrapper">
                    <i class="bi bi-search"></i>
                    <input type="text" id="searchInput" placeholder="Search items by name or SKU..." onkeyup="filterItems()">
                </div>
                <select class="form-select filter-dropdown" id="filterDropdown" onchange="filterItems()">
                    <option value="all">All Items</option>
                    <option value="unallocated">Unallocated</option>
                    <option value="partial">Partially Allocated</option>
                    <option value="filled">Fully Allocated</option>
                </select>
                <button type="button" class="btn-jump" onclick="jumpToFirstUnallocated()">
                    <i class="bi bi-arrow-down-circle"></i>
                    Jump to First Unallocated
                </button>
            </div>

            <!-- Items Table -->
            <div class="table-responsive-mobile">
                <form method="POST" id="packagingForm" action="{{ url_for('packaging.prepare_package', reliefrqst_id=relief_request.reliefrqst_id) }}">
                    {# Hidden fields for optimistic locking #}
                    <input type="hidden" name="relief_request_version" id="relief_request_version" value="{{ relief_request.version_nbr }}">
                    {% if existing_package %}
                    <input type="hidden" name="package_version" id="package_version" value="{{ existing_package.version_nbr }}">
                    {% endif %}
                    <table class="items-table">
                    <thead>
                        <tr>
                            <th scope="col">Item</th>
                            <th scope="col">Requested</th>
                            <th scope="col">Batch Allocation</th>
                            <th scope="col">Allocated</th>
                            <th scope="col">Remaining</th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        {% for item in relief_request.items %}
                        <tr class="item-row" 
                            data-item-id="{{ item.item_id }}" 
                            data-item-name="{{ item.item.item_desc if item.item else 'Unknown' }}"
                            data-item-sku="{{ item.item.sku_code if item.item and item.item.sku_code else '' }}">
                            <td>
                                <div class="item-info">
                                    <span class="item-name">{{ item.item.item_desc if item.item else 'Unknown Item' }}</span>
                                    {% if item.item and item.item.sku_code %}
                                    <span class="item-sku">SKU: {{ item.item.sku_code }}</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <strong data-requested-qty="{{ item.request_qty }}">{{ item.request_qty }}</strong>
                                {% if item.item and item.item.default_uom %}
                                <div class="item-sku">{{ item.item.default_uom.uom_desc }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {% if not is_read_only %}
                                <button 
                                    type="button" 
                                    class="btn btn-outline-secondary select-batches-btn"
                                    onclick="openBatchDrawer({{ item.item_id }}, {{ (item.item.item_desc if item.item else 'Unknown Item') | tojson }}, {{ item.request_qty }})"
                                    data-item-id="{{ item.item_id }}">
                                    <i class="bi bi-box-seam"></i>
                                    Select Batches
                                </button>
                                {% else %}
                                <span class="text-muted">
                                    <i class="bi bi-eye"></i>
                                    View Only
                                </span>
                                {% endif %}
                                {# Hidden inputs for batch allocations - populated from saved draft #}
                                {% if item.item_id in existing_batch_allocations %}
                                    {% for allocation in existing_batch_allocations[item.item_id] %}
                                    <input type="hidden" 
                                           name="batch_allocation_{{ item.item_id }}_{{ allocation.batch_id }}" 
                                           id="batch_allocation_{{ item.item_id }}_{{ allocation.batch_id }}"
                                           value="{{ allocation.qty }}"
                                           data-item-id="{{ item.item_id }}"
                                           data-batch-id="{{ allocation.batch_id }}"
                                           data-warehouse-id="{{ allocation.warehouse_id }}">
                                    {% endfor %}
                                {% endif %}
                            </td>
                            <td>
                                {% set allocated_qty = item_status_options.get(item.item_id, {}).get('total_allocated', 0) %}
                                <strong class="total-allocated" id="total_{{ item.item_id }}">{{ allocated_qty }}</strong>
                            </td>
                            <td>
                                {% set remaining_qty = item.request_qty|float - allocated_qty %}
                                <strong class="remaining-qty" id="remaining_{{ item.item_id }}">{{ remaining_qty }}</strong>
                            </td>
                            <td>
                                {% set status_opts = item_status_options.get(item.item_id, {}) %}
                                {% set allowed = status_opts.get('allowed_codes', [item.status_code]) %}
                                {% set auto = status_opts.get('auto_status', item.status_code) %}
                                <select 
                                    class="form-select form-select-sm status-dropdown" 
                                    name="status_{{ item.item_id }}" 
                                    id="status_{{ item.item_id }}"
                                    data-item-id="{{ item.item_id }}"
                                    data-requested-qty="{{ item.request_qty }}"
                                    data-auto-status="{{ auto }}"
                                    data-allowed-codes="{{ allowed|join(',') }}"
                                    data-has-allocation-activity="{{ 'true' if status_opts.get('has_allocation_activity', False) else 'false' }}"
                                    onchange="toggleReasonField({{ item.item_id }})"
                                    {% if is_read_only %}disabled{% endif %}>
                                    {% for code in allowed %}
                                    {% set label = status_map.get(code, {}).get('desc', code) %}
                                    <option value="{{ code }}" {% if code == item.status_code %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback d-none" id="status_error_{{ item.item_id }}"></div>
                                
                                <!-- Reason field for D/L statuses -->
                                <div class="status-reason-wrapper d-none mt-2" id="reason_wrapper_{{ item.item_id }}">
                                    <textarea 
                                        class="form-control form-control-sm small" 
                                        name="status_reason_{{ item.item_id }}"
                                        id="status_reason_{{ item.item_id }}"
                                        rows="2"
                                        placeholder="Provide reason for this decision..."
                                        {% if is_read_only %}disabled{% endif %}>{{ item.status_reason_desc or '' }}</textarea>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Action Buttons -->
                {% if not is_read_only %}
                <div class="action-buttons">
                    <button type="submit" name="action" value="save_draft" class="btn-relief-secondary">
                        <i class="bi bi-save"></i>
                        Save Draft
                    </button>
                    {% if is_logistics_officer() %}
                    <button type="submit" name="action" value="submit_for_approval" class="btn-relief-primary" id="submitForApprovalBtn">
                        <i class="bi bi-check-circle"></i>
                        Submit for LM Approval
                    </button>
                    {% endif %}
                    {% if is_logistics_manager() %}
                    <button type="submit" name="action" value="send_for_dispatch" class="btn-relief-primary" id="sendForDispatchBtn">
                        <i class="bi bi-truck"></i>
                        Send for Dispatch
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </form>
            
            <!-- Cancel Button -->
            {% if not is_read_only %}
            <div class="mt-3">
                <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#cancelPackageModal">
                    <i class="bi bi-x-circle"></i>
                    Cancel Package Preparation
                </button>
            </div>
            {% endif %}
            </div>
        </div>
        
        <!-- Cancel Package Confirmation Modal -->
        <div class="modal fade" id="cancelPackageModal" tabindex="-1" aria-labelledby="cancelPackageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="cancelPackageModalLabel">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            Cancel Package Preparation
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3"><strong>Are you sure you want to cancel this package preparation?</strong></p>
                        <p class="mb-2">This action will:</p>
                        <ul class="mb-3">
                            <li>Delete all draft allocations</li>
                            <li>Release all inventory reservations</li>
                        </ul>
                        <p class="text-danger mb-0"><strong>This action cannot be undone.</strong></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i>
                            No, Keep Working
                        </button>
                        <button type="button" class="btn btn-danger" onclick="confirmCancelPackage()">
                            <i class="bi bi-trash"></i>
                            Yes, Cancel Package
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workflow Sidebar -->
        <div class="col-lg-3 col-xl-3">
            {{ render_workflow_progress([
                {'title': 'Submitted', 'description': relief_request.agency.agency_name if relief_request.agency else 'Agency', 'status': 'completed'},
                {'title': 'Prepare', 'description': 'Allocate stock', 'status': 'active'},
                {'title': 'Approval', 'description': 'Manager review', 'status': 'pending'},
                {'title': 'Execute', 'description': 'Transfer stock', 'status': 'pending'}
            ], notes_enabled=True) }}
        </div>
    </div>
</div>

<!-- JavaScript for Modern Packaging UI -->
<script nonce="{{ csp_nonce() }}">
document.addEventListener('DOMContentLoaded', function() {
    // Load inventory levels for all items
    loadAllInventory();
    
    // Add event listeners for allocation inputs
    document.querySelectorAll('.allocation-input').forEach(input => {
        input.addEventListener('input', function() {
            const itemId = this.dataset.itemId;
            const warehouseId = this.dataset.warehouseId;
            
            // Update warehouse stock display in real-time
            updateWarehouseStock(itemId, warehouseId);
            
            // Update item calculations and metrics
            updateItemCalculations(itemId);
            updateMetrics();
        });
    });
    
    // Form validation on submit
    document.getElementById('packagingForm').addEventListener('submit', function(e) {
        // Skip validation for cancel button
        const submitter = e.submitter;
        if (!submitter) return; // Browser compatibility
        
        const action = submitter.value || submitter.getAttribute('value');
        
        // Only validate for submit actions, not cancel or save_draft
        if (action === 'submit_for_approval' || action === 'send_for_dispatch') {
            if (!validateAllAllocations()) {
                e.preventDefault();
                alert('Please fix allocation errors before submitting. Check that:\n- No allocation exceeds available stock\n- No total allocation exceeds requested quantity');
            }
        }
    });
    
    // Calculate initial state for pre-populated allocations
    const itemIds = [...new Set([...document.querySelectorAll('.item-row')].map(row => row.dataset.itemId))];
    itemIds.forEach(itemId => {
        updateItemCalculations(itemId);
    });
    
    // Update initial metrics
    updateMetrics();
});

function loadAllInventory() {
    document.querySelectorAll('.allocation-input').forEach(input => {
        const itemId = input.dataset.itemId;
        const warehouseId = input.dataset.warehouseId;
        loadInventory(itemId, warehouseId);
    });
}

function loadInventory(itemId, warehouseId) {
    const stockElement = document.getElementById(`stock_${itemId}_${warehouseId}`);
    
    fetch(`/packaging/api/inventory/${itemId}/${warehouseId}`)
        .then(response => response.json())
        .then(data => {
            const usable = parseFloat(data.usable_qty || 0);
            const reserved = parseFloat(data.reserved_qty || 0);
            
            // Store both usable and reserved quantities
            stockElement.dataset.usableQty = usable;
            stockElement.dataset.reservedQty = reserved;
            
            // Calculate original available as usable - reserved (consistent with DB logic)
            const originalAvailable = Math.max(0, usable - reserved);
            stockElement.dataset.originalQty = originalAvailable;
            
            // Update display with current allocation
            updateWarehouseStock(itemId, warehouseId);
        })
        .catch(error => {
            stockElement.textContent = '?';
            stockElement.classList.add('text-danger');
            stockElement.title = 'Error loading stock';
            console.error('Inventory load error:', error);
        });
}

function updateWarehouseStock(itemId, warehouseId) {
    const stockElement = document.getElementById(`stock_${itemId}_${warehouseId}`);
    const allocationInput = document.getElementById(`allocation_${itemId}_${warehouseId}`);
    
    const usableQty = parseFloat(stockElement.dataset.usableQty || 0);
    const reservedQty = parseFloat(stockElement.dataset.reservedQty || 0);
    const originalAvailable = parseFloat(stockElement.dataset.originalQty || 0);
    const allocated = parseFloat(allocationInput.value || 0);
    const remaining = Math.max(0, originalAvailable - allocated);
    
    stockElement.textContent = remaining.toFixed(0);
    
    // Build tooltip with detailed breakdown
    const tooltip = `Usable: ${usableQty.toFixed(0)}, Reserved (other packages): ${reservedQty.toFixed(0)}, Available: ${originalAvailable.toFixed(0)}, Allocated (this package): ${allocated.toFixed(0)}, Remaining: ${remaining.toFixed(0)}`;
    
    // Remove all color classes first
    stockElement.classList.remove('text-danger', 'text-warning', 'text-body');
    
    if (remaining === 0) {
        stockElement.classList.add('text-danger');
        stockElement.title = tooltip;
    } else if (allocated > 0) {
        stockElement.classList.add('text-warning');
        stockElement.title = tooltip;
    } else {
        stockElement.classList.add('text-body');
        stockElement.title = tooltip;
    }
}

function updateItemCalculations(itemId) {
    // Get allocation inputs for this item
    const allocationInputs = document.querySelectorAll(`.allocation-input[data-item-id="${itemId}"]`);
    
    // Get requested quantity
    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
    const requestedQty = parseFloat(row.querySelector('[data-requested-qty]').dataset.requestedQty);
    
    let totalAllocated = 0;
    
    if (allocationInputs.length > 0) {
        // Calculate from allocation inputs (after batch drawer use)
        allocationInputs.forEach(input => {
            totalAllocated += parseFloat(input.value || 0);
        });
        
        // Update displayed totals
        const totalElement = document.getElementById(`total_${itemId}`);
        totalElement.textContent = totalAllocated.toFixed(2);
        
        const remaining = requestedQty - totalAllocated;
        const remainingElement = document.getElementById(`remaining_${itemId}`);
        remainingElement.textContent = remaining.toFixed(2);
    } else {
        // Read from displayed values (server-calculated on page load)
        const totalElement = document.getElementById(`total_${itemId}`);
        totalAllocated = parseFloat(totalElement.textContent || 0);
    }
    
    // Always update status dropdown and validation (even on page load)
    updateStatusDropdown(itemId, totalAllocated, requestedQty);
    validateQuantityLimit(itemId, totalAllocated, requestedQty);
}

function updateStatusDropdown(itemId, allocated, requested) {
    const statusDropdown = document.getElementById(`status_${itemId}`);
    if (!statusDropdown) return;
    
    // Check if item has allocation activity from server-provided data attribute
    // Once drawer is opened and saved, this flag is set to true and persists
    let hasAllocationActivity = statusDropdown.dataset.hasAllocationActivity === 'true';
    
    // If not set yet, check if batch allocations exist in DOM
    if (!hasAllocationActivity) {
        const allocationInputs = document.querySelectorAll(`input[name^="batch_allocation_${itemId}_"]`);
        hasAllocationActivity = allocationInputs.length > 0;
    }
    
    // Update the flag (will persist even if allocations are cleared)
    if (hasAllocationActivity) {
        statusDropdown.dataset.hasAllocationActivity = 'true';
    }
    
    // Determine default status based on allocation rules
    let defaultStatus;
    let shouldLock = false;
    
    if (allocated === requested && allocated > 0) {
        // Case 1: Fully Allocated - Set to FILLED and lock
        defaultStatus = 'F';  // FILLED
        shouldLock = true;
    } else if (allocated === 0) {
        if (!hasAllocationActivity) {
            // Case 2a: Initial Load - No allocation activity yet
            defaultStatus = 'R';  // REQUESTED
        } else {
            // Case 2b: After allocation activity with zero allocation
            defaultStatus = 'U';  // UNAVAILABLE
        }
        shouldLock = false;
    } else if (allocated > 0 && allocated < requested) {
        // Case 3: Partially Allocated - Default to PARTLY FILLED
        defaultStatus = 'P';  // PARTLY FILLED
        shouldLock = false;
    } else if (allocated > requested) {
        // Over-allocated - Set to FILLED but show validation error
        defaultStatus = 'F';  // FILLED
        shouldLock = false;
    } else {
        // Fallback
        defaultStatus = hasAllocationActivity ? 'U' : 'R';
        shouldLock = false;
    }
    
    // Update data attribute
    statusDropdown.dataset.autoStatus = defaultStatus;
    
    // Always reset to default status when returning from drawer
    // This ensures status matches current allocation state
    statusDropdown.value = defaultStatus;
    
    // Update disabled state
    if (shouldLock) {
        statusDropdown.disabled = true;
        statusDropdown.classList.add('is-locked');
    } else {
        statusDropdown.disabled = false;
        statusDropdown.classList.remove('is-locked');
    }
    
    // Update allowed options based on allocation state
    updateAllowedStatusOptions(itemId, allocated, requested, defaultStatus, hasAllocationActivity);
}

function updateAllowedStatusOptions(itemId, allocated, requested, defaultStatus, hasAllocationActivity) {
    const statusDropdown = document.getElementById(`status_${itemId}`);
    if (!statusDropdown) return;
    
    // Determine allowed status codes based on allocation
    let allowedCodes;
    
    if (allocated === requested && allocated > 0) {
        // Case 1: Fully Allocated - Only FILLED allowed, dropdown locked
        allowedCodes = ['F'];  // FILLED only
    } else if (allocated === 0) {
        if (!hasAllocationActivity) {
            // Case 2a: Initial Load - REQUESTED, UNAVAILABLE, DENIED, AWAITING AVAILABILITY
            allowedCodes = ['R', 'U', 'D', 'W'];
        } else {
            // Case 2b: After allocation activity - UNAVAILABLE, DENIED, AWAITING AVAILABILITY (no REQUESTED)
            allowedCodes = ['U', 'D', 'W'];
        }
    } else if (allocated > 0 && allocated < requested) {
        // Case 3: Partially Allocated - PARTLY FILLED, ALLOWED LIMIT
        allowedCodes = ['P', 'L'];  // PARTLY FILLED, ALLOWED LIMIT
    } else if (allocated > requested) {
        // Over-allocated - Show FILLED only (with error)
        allowedCodes = ['F'];
    } else {
        // Fallback
        allowedCodes = hasAllocationActivity ? ['U', 'D', 'W'] : ['R', 'U', 'D', 'W'];
    }
    
    // Store status map from template
    const statusMap = {{ status_map|tojson }};
    
    // Rebuild dropdown options with ONLY the allowed codes
    // Do NOT preserve previous selections outside allowed codes
    statusDropdown.innerHTML = '';
    allowedCodes.forEach(code => {
        const option = document.createElement('option');
        option.value = code;
        option.textContent = statusMap[code]?.desc || code;
        if (code === defaultStatus) {
            option.selected = true;
        }
        statusDropdown.appendChild(option);
    });
    
    // Update data attribute with allowed codes
    statusDropdown.dataset.allowedCodes = allowedCodes.join(',');
}

function validateQuantityLimit(itemId, allocated, requested) {
    const errorDiv = document.getElementById(`status_error_${itemId}`);
    const statusDropdown = document.getElementById(`status_${itemId}`);
    
    if (allocated > requested) {
        statusDropdown.classList.add('is-invalid');
        errorDiv.textContent = `Total allocated (${allocated.toFixed(2)}) exceeds requested (${requested.toFixed(2)})`;
        errorDiv.classList.remove('d-none');
        errorDiv.classList.add('d-block');
        return false;
    } else {
        statusDropdown.classList.remove('is-invalid');
        errorDiv.classList.remove('d-block');
        errorDiv.classList.add('d-none');
        return true;
    }
}

function toggleReasonField(itemId) {
    const statusDropdown = document.getElementById(`status_${itemId}`);
    const reasonWrapper = document.getElementById(`reason_wrapper_${itemId}`);
    const reasonField = document.getElementById(`status_reason_${itemId}`);
    
    if (!statusDropdown || !reasonWrapper) return;
    
    const selectedStatus = statusDropdown.value;
    
    // Show reason field for D (Denied) or L (Allowed Limit)
    if (selectedStatus === 'D' || selectedStatus === 'L') {
        reasonWrapper.classList.remove('d-none');
        reasonField.setAttribute('required', 'required');
    } else {
        reasonWrapper.classList.add('d-none');
        reasonField.removeAttribute('required');
        reasonField.value = ''; // Clear the field when hidden
    }
}

// Initialize reason fields on page load
document.addEventListener('DOMContentLoaded', function() {
    const statusDropdowns = document.querySelectorAll('.status-dropdown');
    statusDropdowns.forEach(dropdown => {
        const itemId = dropdown.dataset.itemId;
        if (itemId) {
            toggleReasonField(itemId);
        }
    });
});

function updateMetrics() {
    const totalItems = document.querySelectorAll('.item-row').length;
    let fullyAllocated = 0;
    let partiallyAllocated = 0;
    let unallocated = 0;
    
    document.querySelectorAll('.item-row').forEach(row => {
        const itemId = row.dataset.itemId;
        const requestedQty = parseFloat(row.querySelector('[data-requested-qty]').dataset.requestedQty);
        
        // Read the displayed total allocated value (which may be server-calculated or JS-updated)
        const totalAllocatedElement = document.getElementById(`total_${itemId}`);
        const totalAllocated = parseFloat(totalAllocatedElement.textContent || 0);
        
        if (totalAllocated === 0) {
            unallocated++;
        } else if (totalAllocated >= requestedQty) {
            fullyAllocated++;
        } else {
            partiallyAllocated++;
        }
    });
    
    document.getElementById('metric-total').textContent = totalItems;
    document.getElementById('metric-filled').textContent = fullyAllocated;
    document.getElementById('metric-partial').textContent = partiallyAllocated;
    document.getElementById('metric-unallocated').textContent = unallocated;
}

function filterItems() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const filterValue = document.getElementById('filterDropdown').value;
    
    document.querySelectorAll('.item-row').forEach(row => {
        const itemName = row.dataset.itemName.toLowerCase();
        const itemSku = row.dataset.itemSku.toLowerCase();
        const itemId = row.dataset.itemId;
        
        // Check search match
        const searchMatch = itemName.includes(searchTerm) || itemSku.includes(searchTerm);
        
        // Check filter match
        let filterMatch = true;
        if (filterValue !== 'all') {
            const requestedQty = parseFloat(row.querySelector('[data-requested-qty]').dataset.requestedQty);
            // Read the displayed total allocated value
            const totalAllocatedElement = document.getElementById(`total_${itemId}`);
            const totalAllocated = parseFloat(totalAllocatedElement.textContent || 0);
            
            if (filterValue === 'unallocated') {
                filterMatch = totalAllocated === 0;
            } else if (filterValue === 'partial') {
                filterMatch = totalAllocated > 0 && totalAllocated < requestedQty;
            } else if (filterValue === 'filled') {
                filterMatch = totalAllocated >= requestedQty;
            }
        }
        
        // Show or hide row
        if (searchMatch && filterMatch) {
            row.classList.remove('row-hidden');
        } else {
            row.classList.add('row-hidden');
        }
    });
}

function jumpToFirstUnallocated() {
    const rows = document.querySelectorAll('.item-row');
    
    for (let row of rows) {
        const itemId = row.dataset.itemId;
        // Read the displayed total allocated value
        const totalAllocatedElement = document.getElementById(`total_${itemId}`);
        const totalAllocated = parseFloat(totalAllocatedElement.textContent || 0);
        
        if (totalAllocated === 0 && !row.classList.contains('row-hidden')) {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            row.classList.add('bg-warning-light');
            setTimeout(() => {
                row.classList.remove('bg-warning-light');
            }, 2000);
            return;
        }
    }
    
    alert('No unallocated items found.');
}

function validateAllAllocations() {
    let valid = true;
    const errors = [];
    
    // Validate individual allocations against available stock (usable - reserved)
    document.querySelectorAll('.allocation-input').forEach(input => {
        const itemId = input.dataset.itemId;
        const warehouseId = input.dataset.warehouseId;
        const allocated = parseFloat(input.value || 0);
        const stockElement = document.getElementById(`stock_${itemId}_${warehouseId}`);
        const usableQty = parseFloat(stockElement.dataset.usableQty || 0);
        const reservedQty = parseFloat(stockElement.dataset.reservedQty || 0);
        const availableQty = usableQty - reservedQty;
        
        if (allocated > availableQty) {
            valid = false;
            input.classList.add('border-danger', 'shadow-danger');
        } else {
            input.classList.remove('border-danger', 'shadow-danger');
        }
    });
    
    // Validate total allocations don't exceed requested
    document.querySelectorAll('.item-row').forEach(row => {
        const itemId = row.dataset.itemId;
        const requestedQty = parseFloat(row.querySelector('[data-requested-qty]').dataset.requestedQty);
        
        let totalAllocated = 0;
        document.querySelectorAll(`.allocation-input[data-item-id="${itemId}"]`).forEach(input => {
            totalAllocated += parseFloat(input.value || 0);
        });
        
        const totalElement = document.getElementById(`total_${itemId}`);
        if (totalAllocated > requestedQty) {
            valid = false;
            totalElement.classList.add('text-danger');
        } else {
            totalElement.classList.remove('text-danger');
        }
    });
    
    return valid;
}

function confirmCancelPackage() {
    console.log('confirmCancelPackage called - User confirmed cancellation');
    try {
        // Create and submit a form to POST to the cancel route
        const cancelUrl = '{{ url_for("packaging.cancel_preparation", reliefrqst_id=relief_request.reliefrqst_id) }}';
        console.log('Cancel URL:', cancelUrl);
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = cancelUrl;
        
        document.body.appendChild(form);
        console.log('Form created and appended, submitting now...');
        form.submit();
    } catch (error) {
        console.error('Error in confirmCancelPackage:', error);
        alert('An error occurred while trying to cancel: ' + error.message);
    }
}
</script>

{# Batch Allocation Module #}
<script  nonce="{{ csp_nonce() }}" src="{{ url_for('static', filename='js/batch-allocation.js') }}"></script>

{# Batch Selection Drawer #}
{% include 'packaging/_batch_drawer.html' %}

{% endblock %}

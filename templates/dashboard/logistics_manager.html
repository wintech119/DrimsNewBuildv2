{% extends "base.html" %}
{% from "macros.html" import kpi_card, status_badge, data_table %}
{% block title %}Logistics Manager Dashboard - DMIS{% endblock %}

{% set active_page = 'dashboard' %}

{% block extra_styles %}
<script  nonce="{{ csp_nonce() }}" src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" integrity="sha384-e6nUZLBkQ86NJ6TVVKAeSaK8jWa3NhkYWZFomE39AvDbQWeie9PlQqM3pmYW5d1g" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1"><i class="bi bi-grid-3x3-gap-fill"></i> Logistics Manager Dashboard</h2>
        <p class="text-muted mb-0">System overview and operational metrics</p>
    </div>
    <div class="text-muted">
        <i class="bi bi-clock"></i> {{ now.strftime('%B %d, %Y %H:%M') }}
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3 col-lg-2">
        {{ kpi_card('building', 'Main Hubs', warehouse_stock|selectattr('warehouse_name', 'search', 'Main')|list|length, 'primary') }}
    </div>
    <div class="col-md-3 col-lg-2">
        {{ kpi_card('building-check', 'Sub-Hubs', warehouse_stock|selectattr('warehouse_name', 'search', 'Sub')|list|length, 'info') }}
    </div>
    <div class="col-md-3 col-lg-2">
        {{ kpi_card('building-fill', 'Agency Hubs', warehouse_stock|selectattr('warehouse_name', 'search', 'Agency')|list|length, 'success') }}
    </div>
    <div class="col-md-3 col-lg-2">
        {{ kpi_card('box-seam', 'Gov Stock', total_items, 'warning') }}
    </div>
    <div class="col-md-3 col-lg-2">
        {{ kpi_card('inbox', 'Open Requests', needs_by_status.get('Submitted', 0), 'danger') }}
    </div>
    <div class="col-md-3 col-lg-2">
        {{ kpi_card('cash-stack', 'Stock Value', '$%.0f'|format(total_inventory_value), 'primary') }}
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header card-header-goj">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Hub Status Overview</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="text-success" style="font-size: 2rem;"><i class="bi bi-check-circle-fill"></i></div>
                        <h4 class="mb-0">{{ total_warehouses }}</h4>
                        <small class="text-muted">Active Hubs</small>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="text-danger" style="font-size: 2rem;"><i class="bi bi-exclamation-triangle-fill"></i></div>
                        <h4 class="mb-0">{{ low_stock_items|length }}</h4>
                        <small class="text-muted">Low Stock Items</small>
                    </div>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Storage Capacity</span>
                    <span class="fw-bold">75%</span>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: 75%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header card-header-goj">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Category Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header card-header-goj d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-building"></i> Hub Status Table</h5>
                <a href="{{ url_for('warehouses.list_warehouses') }}" class="btn btn-sm btn-light">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="py-2 px-3">Hub Name</th>
                                <th class="py-2 px-3 text-end">Item Count</th>
                                <th class="py-2 px-3 text-end">Total Quantity</th>
                                <th class="py-2 px-3">Status</th>
                                <th class="py-2 px-3 text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for wh in warehouse_stock %}
                            <tr style="cursor: pointer;" onclick="window.location='{{ url_for('warehouses.view', warehouse_id=wh.warehouse_id) }}'">
                                <td class="py-2 px-3"><strong>{{ wh.warehouse_name }}</strong></td>
                                <td class="py-2 px-3 text-end">{{ wh.item_count }}</td>
                                <td class="py-2 px-3 text-end">{{ "%.2f"|format(wh.total_qty) }}</td>
                                <td class="py-2 px-3">
                                    <span class="badge bg-success">Active</span>
                                </td>
                                <td class="py-2 px-3 text-end">
                                    <a href="{{ url_for('warehouses.view', warehouse_id=wh.warehouse_id) }}" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pending Fulfillment Section -->
<div class="row g-3 mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header card-header-goj d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-box-seam"></i> Relief Request Fulfillment Queue</h5>
                <a href="{{ url_for('packaging.pending_fulfillment') }}" class="btn btn-sm btn-light">View All</a>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-md-4">
                        <div class="p-3 bg-warning bg-opacity-10 rounded">
                            <h3 class="mb-1 text-warning">{{ packaging_counts.awaiting }}</h3>
                            <small class="text-muted">Awaiting to be Filled</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 bg-info bg-opacity-10 rounded">
                            <h3 class="mb-1 text-info">{{ packaging_counts.in_progress }}</h3>
                            <small class="text-muted">Being Prepared</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 bg-success bg-opacity-10 rounded">
                            <h3 class="mb-1 text-success">{{ packaging_counts.ready }}</h3>
                            <small class="text-muted">Ready for Dispatch</small>
                        </div>
                    </div>
                </div>
                
                {% if pending_fulfillment_requests %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="py-2 px-3">Request Number</th>
                                <th class="py-2 px-3">Agency</th>
                                <th class="py-2 px-3">Items</th>
                                <th class="py-2 px-3">Status</th>
                                <th class="py-2 px-3 text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for req in pending_fulfillment_requests %}
                            <tr>
                                <td class="py-2 px-3">
                                    <strong>RR-{{ '%06d'|format(req.reliefrqst_id) }}</strong>
                                </td>
                                <td class="py-2 px-3">
                                    {{ req.agency.agency_name if req.agency else 'Unknown' }}
                                </td>
                                <td class="py-2 px-3">
                                    {{ req.items|length if req.items else 0 }} items
                                </td>
                                <td class="py-2 px-3">
                                    {% if req.fulfillment_lock %}
                                    <span class="badge bg-info">Being Prepared</span>
                                    {% elif req.status %}
                                    <span class="badge {% if req.status_code == STATUS_SUBMITTED %}bg-warning{% elif req.status_code == STATUS_PART_FILLED %}bg-success{% endif %}">
                                        {{ req.status.status_desc }}
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="py-2 px-3 text-end">
                                    <a href="{{ url_for('packaging.prepare_package', reliefrqst_id=req.reliefrqst_id) }}" 
                                       class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();">
                                        <i class="bi bi-box-seam"></i> Prepare
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-3 text-center text-muted">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p class="mb-0 mt-2">No relief requests pending fulfillment</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="bi bi-inbox"></i> Submitted ({{ needs_by_status.get('Submitted', 0) }})</h6>
            </div>
            <div class="card-body p-0">
                {% if submitted_needs %}
                <div class="list-group list-group-flush">
                    {% for need in submitted_needs[:5] %}
                    <a href="{{ url_for('needs_list.view', needs_list_id=need.needs_list_id) }}" class="list-group-item list-group-item-action border-0">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <strong class="text-primary">{{ need.needs_list_nbr }}</strong>
                                <br>
                                <small class="text-muted">
                                    {% if need.agency %}{{ need.agency.agency_name }}{% endif %}
                                </small>
                            </div>
                            <small class="text-muted">{{ need.create_dtime.strftime('%m/%d') }}</small>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-3 text-center text-muted">
                    <i class="bi bi-inbox"></i>
                    <p class="mb-0 mt-2 small">No submitted requests</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-box-seam"></i> Fulfilment Prepared ({{ fulfilment_by_status.get('Ready', 0) }})</h6>
            </div>
            <div class="card-body p-0">
                {% if ready_fulfilments %}
                <div class="list-group list-group-flush">
                    {% for ful in ready_fulfilments[:5] %}
                    <a href="{{ url_for('fulfilment.view', fulfilment_id=ful.fulfilment_id) }}" class="list-group-item list-group-item-action border-0">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <strong class="text-info">{{ ful.fulfilment_nbr }}</strong>
                                <br>
                                <small class="text-muted">
                                    {% if ful.warehouse %}{{ ful.warehouse.warehouse_name }}{% endif %}
                                </small>
                            </div>
                            <small class="text-muted">{{ ful.create_dtime.strftime('%m/%d') }}</small>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-3 text-center text-muted">
                    <i class="bi bi-box-seam"></i>
                    <p class="mb-0 mt-2 small">No prepared fulfilments</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="bi bi-hourglass-split"></i> Awaiting Approval ({{ needs_by_status.get('Awaiting Approval', 0) }})</h6>
            </div>
            <div class="card-body p-0">
                {% if awaiting_approval_needs %}
                <div class="list-group list-group-flush">
                    {% for need in awaiting_approval_needs[:5] %}
                    <a href="{{ url_for('needs_list.view', needs_list_id=need.needs_list_id) }}" class="list-group-item list-group-item-action border-0">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <strong class="text-warning">{{ need.needs_list_nbr }}</strong>
                                <br>
                                <small class="text-muted">
                                    {% if need.agency %}{{ need.agency.agency_name }}{% endif %}
                                </small>
                            </div>
                            <small class="text-muted">{{ need.create_dtime.strftime('%m/%d') }}</small>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-3 text-center text-muted">
                    <i class="bi bi-hourglass-split"></i>
                    <p class="mb-0 mt-2 small">No pending approvals</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script nonce="{{ csp_nonce() }}">
const ctx = document.getElementById('categoryChart').getContext('2d');
const categoryData = {{ category_distribution|tojson }};

const labels = categoryData.map(c => c[0] || 'Uncategorized');
const data = categoryData.map(c => parseFloat(c[2]) || 0);

new Chart(ctx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: 'Quantity',
            data: data,
            backgroundColor: 'rgba(0, 150, 57, 0.7)',
            borderColor: 'rgb(0, 150, 57)',
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            title: {
                display: false
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                grid: {
                    display: true
                }
            },
            y: {
                grid: {
                    display: false
                }
            }
        }
    }
});
</script>
{% endblock %}

{% extends "base.html" %}
{% from "macros.html" import kpi_card, status_badge, data_table %}
{% block title %}Dashboard - DMIS{% endblock %}

{% set active_page = 'dashboard' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0"><i class="bi bi-grid-3x3-gap-fill"></i> System Dashboard</h2>
    <div class="text-muted">
        <i class="bi bi-clock"></i> Last updated: {{ now.strftime('%B %d, %Y %H:%M') if now else 'Just now' }}
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        {{ kpi_card('box-seam', 'Active Items', total_items, 'primary') }}
    </div>
    <div class="col-md-3">
        {{ kpi_card('building', 'Warehouses', total_warehouses, 'success') }}
    </div>
    <div class="col-md-3">
        {{ kpi_card('calendar-event', 'Active Events', total_events, 'warning') }}
    </div>
    <div class="col-md-3">
        {{ kpi_card('cash-stack', 'Total Value', '$%.2f'|format(total_inventory_value), 'info') }}
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Low Stock Alerts</h5>
                {% if low_stock_items %}
                <span class="badge bg-white text-danger">{{ low_stock_items|length }} items</span>
                {% endif %}
            </div>
            <div class="card-body p-0">
                {% if low_stock_items %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="py-2 px-3">Item</th>
                                <th class="py-2 px-3 text-end">Current</th>
                                <th class="py-2 px-3 text-end">Reorder Level</th>
                                <th class="py-2 px-3 text-end">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in low_stock_items %}
                            <tr style="cursor: pointer;" onclick="window.location='{{ url_for('items.view', item_id=item.item_id) }}'">
                                <td class="py-2 px-3">{{ item.item_name }}</td>
                                <td class="py-2 px-3 text-end">{{ "%.2f"|format(item.total_qty) }}</td>
                                <td class="py-2 px-3 text-end">{{ "%.2f"|format(item.reorder_level) }}</td>
                                <td class="py-2 px-3 text-end">
                                    <span class="badge bg-danger">Low</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center text-muted">
                    <i class="bi bi-check-circle fs-1"></i>
                    <p class="mb-0 mt-2">All items are adequately stocked.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header card-header-goj d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-building"></i> Warehouse Stock Levels</h5>
                <a href="{{ url_for('warehouses.list_warehouses') }}" class="btn btn-sm btn-light">View All</a>
            </div>
            <div class="card-body p-0">
                {% if warehouse_stock %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="py-2 px-3">Warehouse</th>
                                <th class="py-2 px-3 text-end">Items</th>
                                <th class="py-2 px-3 text-end">Total Qty</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for wh in warehouse_stock %}
                            <tr style="cursor: pointer;" onclick="window.location='{{ url_for('warehouses.view', warehouse_id=wh.warehouse_id) }}'">
                                <td class="py-2 px-3">{{ wh.warehouse_name }}</td>
                                <td class="py-2 px-3 text-end">{{ wh.item_count }}</td>
                                <td class="py-2 px-3 text-end">{{ "%.2f"|format(wh.total_qty) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center text-muted">
                    <p class="mb-0">No inventory data available.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if active_events %}
<div class="row g-3">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header card-header-goj d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Active Disaster Events</h5>
                <a href="{{ url_for('events.list_events') }}" class="btn btn-sm btn-light">Manage Events</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="py-2 px-3">Event ID</th>
                                <th class="py-2 px-3">Event Name</th>
                                <th class="py-2 px-3">Type</th>
                                <th class="py-2 px-3">Start Date</th>
                                <th class="py-2 px-3">Parish</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in active_events %}
                            <tr style="cursor: pointer;" onclick="window.location='{{ url_for('events.view', event_id=event.event_id) }}'">
                                <td class="py-2 px-3"><strong>{{ event.event_id }}</strong></td>
                                <td class="py-2 px-3">{{ event.event_name }}</td>
                                <td class="py-2 px-3">{{ event.event_type_desc }}</td>
                                <td class="py-2 px-3">{{ event.event_start_date.strftime('%Y-%m-%d') if event.event_start_date else 'N/A' }}</td>
                                <td class="py-2 px-3">{{ event.parish.parish_name if event.parish else 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

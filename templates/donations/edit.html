{% extends 'base.html' %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/relief-requests-ui.css') }}">
{% endblock %}

{% block title %}Edit Donation #{{ donation.donation_id }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="page-header mb-0">
            <div class="page-title">
                <i class="bi bi-pencil page-title-icon"></i>
                <h1 class="page-title-text">Edit Donation #{{ donation.donation_id }}</h1>
            </div>
        </div>
        <a href="{{ url_for('donations.view_donation', donation_id=donation.donation_id) }}" class="btn-relief-secondary">
            <i class="bi bi-arrow-left"></i> Back to View
        </a>
    </div>

    <!-- Form Card -->
    <div class="row">
        <div class="col-lg-10 col-xl-8">
            <div class="card">
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('donations.edit_donation', donation_id=donation.donation_id) }}" enctype="multipart/form-data" novalidate>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="version_nbr" value="{{ donation.version_nbr }}">
                        
                        <!-- Donation Information Section -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> Donation Information
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="donor_id" class="form-label">
                                        Donor <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="donor_id" name="donor_id" required>
                                        <option value="">-- Select Donor --</option>
                                        {% for donor in donors %}
                                        <option value="{{ donor.donor_id }}" 
                                                {% if (form_data and form_data.get('donor_id')|string == donor.donor_id|string) or (not form_data and donor.donor_id == donation.donor_id) %}selected{% endif %}>
                                            {{ donor.donor_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="event_id" class="form-label">
                                        Event <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="event_id" name="event_id" required>
                                        <option value="">-- Select Event --</option>
                                        {% for event in events %}
                                        <option value="{{ event.event_id }}" 
                                                {% if (form_data and form_data.get('event_id')|string == event.event_id|string) or (not form_data and event.event_id == donation.event_id) %}selected{% endif %}>
                                            {{ event.event_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Description and Date Section -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-file-text"></i> Description and Details
                            </h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="donation_desc" class="form-label">
                                        Donation Description <span class="text-danger">*</span>
                                    </label>
                                    <textarea class="form-control text-uppercase" 
                                              id="donation_desc" 
                                              name="donation_desc" 
                                              rows="3" 
                                              required 
                                              placeholder="Describe the donation contents and source...">{{ form_data.get('donation_desc') if form_data else donation.donation_desc }}</textarea>
                                    <small class="form-text text-muted">Auto-converted to uppercase</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="received_date" class="form-label">
                                        Received Date <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" 
                                           class="form-control" 
                                           id="received_date" 
                                           name="received_date" 
                                           max="{{ today }}" 
                                           value="{{ form_data.get('received_date') if form_data else donation.received_date.isoformat() }}"
                                           required>
                                    <small class="form-text text-muted">Cannot be a future date</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="custodian_id" class="form-label">
                                        Custodian <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="custodian_id" name="custodian_id" required>
                                        <option value="">-- Select Custodian --</option>
                                        {% for custodian in custodians %}
                                        <option value="{{ custodian.custodian_id }}" 
                                                {% if (form_data and form_data.get('custodian_id')|string == custodian.custodian_id|string) or (not form_data and custodian.custodian_id == donation.custodian_id) %}selected{% endif %}>
                                            {{ custodian.custodian_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Origin Information Section -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-geo-alt"></i> Origin Information
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="origin_country_id" class="form-label">
                                        Origin Country <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="origin_country_id" name="origin_country_id" required>
                                        <option value="">-- Select Country --</option>
                                        {% for country in countries %}
                                        <option value="{{ country.country_id }}" 
                                                data-currency="{{ country.currency_code }}"
                                                {% if (form_data and form_data.get('origin_country_id')|string == country.country_id|string) or (not form_data and donation.origin_country_id and country.country_id|string == donation.origin_country_id|string) %}selected{% endif %}>
                                            {{ country.country_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">Currency will default based on country</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="origin_address1_text" class="form-label">
                                        Address Line 1
                                    </label>
                                    <input type="text" 
                                           class="form-control text-uppercase" 
                                           id="origin_address1_text" 
                                           name="origin_address1_text" 
                                           placeholder="Street address..."
                                           value="{{ form_data.get('origin_address1_text') if form_data else (donation.origin_address1_text or '') }}">
                                </div>
                                <div class="col-md-12">
                                    <label for="origin_address2_text" class="form-label">
                                        Address Line 2
                                    </label>
                                    <input type="text" 
                                           class="form-control text-uppercase" 
                                           id="origin_address2_text" 
                                           name="origin_address2_text" 
                                           placeholder="City, state/province, postal code..."
                                           value="{{ form_data.get('origin_address2_text') if form_data else (donation.origin_address2_text or '') }}">
                                </div>
                            </div>
                        </div>

                        <!-- Cost Breakdown Section -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-currency-dollar"></i> Cost Breakdown
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="tot_item_cost" class="form-label">
                                        Total Donation Value
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="tot_item_cost" 
                                           name="tot_item_cost" 
                                           data-money-format="true"
                                           value="{{ form_data.get('tot_item_cost') if form_data else (donation.tot_item_cost|default('0.00', true)) }}"
                                           readonly>
                                    <small class="form-text text-muted">Auto-calculated from items</small>
                                </div>
                                <div class="col-md-3">
                                    <label for="storage_cost" class="form-label">
                                        Storage Cost
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="storage_cost" 
                                           name="storage_cost" 
                                           data-money-format="true"
                                           value="{{ form_data.get('storage_cost') if form_data else (donation.storage_cost|default('', true)) }}"
                                           placeholder="$0.00">
                                    <small class="form-text text-muted">Warehousing costs</small>
                                </div>
                                <div class="col-md-3">
                                    <label for="haulage_cost" class="form-label">
                                        Haulage Cost
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="haulage_cost" 
                                           name="haulage_cost" 
                                           data-money-format="true"
                                           value="{{ form_data.get('haulage_cost') if form_data else (donation.haulage_cost|default('', true)) }}"
                                           placeholder="$0.00">
                                    <small class="form-text text-muted">Transportation costs</small>
                                </div>
                                <div class="col-md-3">
                                    <label for="other_cost" class="form-label">
                                        Other Cost
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="other_cost" 
                                           name="other_cost" 
                                           data-money-format="true"
                                           value="{{ form_data.get('other_cost') if form_data else (donation.other_cost|default('', true)) }}"
                                           placeholder="$0.00">
                                    <small class="form-text text-muted">Miscellaneous costs</small>
                                </div>
                                <div class="col-md-12">
                                    <label for="other_cost_desc" class="form-label">
                                        Other Cost Description
                                    </label>
                                    <input type="text" 
                                           class="form-control text-uppercase" 
                                           id="other_cost_desc" 
                                           name="other_cost_desc" 
                                           placeholder="Describe other costs..."
                                           value="{{ form_data.get('other_cost_desc') if form_data else (donation.other_cost_desc or '') }}"
                                           {% if not form_data and (not donation.other_cost or donation.other_cost == 0) %}disabled{% endif %}>
                                    <small class="form-text text-muted">Required when Other Cost > 0</small>
                                </div>
                            </div>
                        </div>

                        <!-- Comments Section -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-chat-left-text"></i> Additional Comments
                            </h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="comments_text" class="form-label">
                                        Comments
                                    </label>
                                    <textarea class="form-control text-uppercase" 
                                              id="comments_text" 
                                              name="comments_text" 
                                              rows="2"
                                              placeholder="Optional comments about this donation...">{{ form_data.get('comments_text') if form_data else (donation.comments_text or '') }}</textarea>
                                    <small class="form-text text-muted">Auto-converted to uppercase</small>
                                </div>
                            </div>
                        </div>

                        <!-- Donation Items Section -->
                        <div class="mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="mb-3"><i class="bi bi-plus-circle"></i> Add Donation Item</h5>
                                    
                                    <div id="addItemForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="new_item_id" class="form-label">Item *</label>
                                                <select class="form-select" id="new_item_id">
                                                    <option value="">Select item...</option>
                                                    {% for item in items %}
                                                    <option value="{{ item.item_id }}" data-name="{{ item.item_name }}" data-uom="{{ item.default_uom_code }}">
                                                        {{ item.item_name }} ({{ item.sku_code }})
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="new_donation_type" class="form-label">
                                                    Type * 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Auto-set based on item category"></i>
                                                </label>
                                                <input type="text" class="form-control field-disabled-visual" id="new_donation_type" value="" readonly placeholder="Select item first">
                                                <small class="text-muted" id="category_hint">Auto-set</small>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="new_quantity" class="form-label">Quantity *</label>
                                                <input type="number" class="form-control" id="new_quantity" step="0.01" min="0" value="1.00" placeholder="1.00">
                                                <small class="text-muted" id="quantity_hint">Default: 1.00</small>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="new_item_cost" class="form-label">
                                                    Item Cost * 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Cost per unit"></i>
                                                </label>
                                                <input type="text" class="form-control" id="new_item_cost" data-money-format="true" value="" placeholder="$0.00">
                                                <small class="text-muted" id="item_cost_hint">Cost per unit</small>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="new_uom_code" class="form-label">UOM *</label>
                                                <select class="form-select field-disabled-visual" id="new_uom_code" disabled>
                                                    <option value="">Select item first</option>
                                                    {% for uom in uoms %}
                                                    <option value="{{ uom.uom_code }}" data-desc="{{ uom.uom_desc }}">
                                                        {{ uom.uom_desc }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                <input type="hidden" id="new_uom_code_hidden" value="">
                                                <small class="text-muted" id="uom_hint">Unit: <span id="selected_uom">—</span></small>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="new_location_name" class="form-label">Location *</label>
                                                <input type="text" class="form-control text-uppercase" id="new_location_name" value="DONATION RECEIVED">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label for="new_item_comments" class="form-label">Item Comments</label>
                                                <input type="text" class="form-control text-uppercase" id="new_item_comments" placeholder="Optional comments about this item...">
                                            </div>
                                        </div>
                                        <button type="button" class="btn-relief-primary" id="addItemBtn">
                                            <i class="bi bi-plus-circle"></i> Add Item to Donation
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Current Items (<span id="itemCount">0</span>)</h5>
                                    </div>

                                    <div id="itemsTableContainer"></div>
                                    
                                    <div id="noItemsMessage" class="text-center py-4 d-none">
                                        <i class="bi bi-inbox empty-state-icon"></i>
                                        <p class="text-muted mt-2 mb-0">No items added yet. Use the form above to add items to this donation.</p>
                                    </div>

                                    <div id="itemsContainer" class="d-none">
                                        <!-- Hidden inputs for form submission -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                            <a href="{{ url_for('donations.view_donation', donation_id=donation.donation_id) }}" class="btn-relief-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn-relief-primary" id="submitBtn">
                                <i class="bi bi-check-circle"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ csp_nonce() }}">
let itemCounter = 0;
const donationItems = [];
let currentCategoryType = null;

// Load existing items from the database
const existingItems = {{ existing_items | tojson | safe if existing_items else '[]' }};

document.addEventListener('DOMContentLoaded', function() {
    const itemsDropdown = document.getElementById('new_item_id');
    
    // Load existing items into the donationItems array
    existingItems.forEach(function(item) {
        const option = itemsDropdown.querySelector(`option[value="${item.item_id}"]`);
        const itemName = option ? option.getAttribute('data-name') : item.item_name;
        
        itemCounter++;
        donationItems.push({
            id: itemCounter,
            is_existing: true,
            item_id: item.item_id,
            item_name: itemName,
            donation_type: item.donation_type,
            quantity: item.quantity,
            item_cost: item.item_cost,
            uom_code: item.uom_code,
            uom_desc: item.uom_code,
            location_name: item.location_name,
            comments: item.comments
        });
    });
    
    if (donationItems.length > 0) {
        updateItemsTable();
    }
    
    // Initialize tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(function(tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Other cost description toggle
    const otherCostInput = document.getElementById('other_cost');
    const otherCostDescInput = document.getElementById('other_cost_desc');
    
    otherCostInput.addEventListener('input', function() {
        const val = parseFloat(this.value) || 0;
        if (val > 0) {
            otherCostDescInput.disabled = false;
            otherCostDescInput.required = true;
        } else {
            otherCostDescInput.disabled = true;
            otherCostDescInput.required = false;
            otherCostDescInput.value = '';
        }
    });
});

// Fetch item category and adjust form fields dynamically
document.getElementById('new_item_id').addEventListener('change', async function() {
    const itemId = this.value;
    const donationTypeInput = document.getElementById('new_donation_type');
    const categoryHint = document.getElementById('category_hint');
    const quantityHint = document.getElementById('quantity_hint');
    const itemCostHint = document.getElementById('item_cost_hint');
    const uomSelect = document.getElementById('new_uom_code');
    const uomHidden = document.getElementById('new_uom_code_hidden');
    const uomHint = document.getElementById('selected_uom');
    
    if (!itemId) {
        resetFormFields();
        return;
    }
    
    try {
        const response = await fetch(`{{ url_for('donations.get_item_category', item_id=0) }}`.replace('/0', `/${itemId}`));
        if (!response.ok) {
            throw new Error('Failed to fetch item category');
        }
        
        const data = await response.json();
        currentCategoryType = data.category_type;
        
        donationTypeInput.value = data.category_type;
        categoryHint.textContent = `${data.category_desc} (${data.category_type})`;
        
        uomSelect.value = data.default_uom_code;
        uomHidden.value = data.default_uom_code;
        uomHint.textContent = data.default_uom_code;
        
        if (data.category_type === 'GOODS') {
            enableFieldsForGoods();
        } else if (data.category_type === 'FUNDS') {
            enableFieldsForFunds();
        }
        
    } catch (error) {
        console.error('Error fetching category:', error);
        alert('Error loading item category information. Please try again.');
        resetFormFields();
    }
});

function enableFieldsForGoods() {
    const itemCostHint = document.getElementById('item_cost_hint');
    const quantityHint = document.getElementById('quantity_hint');
    
    itemCostHint.textContent = 'Cost per unit';
    quantityHint.textContent = 'Quantity of goods';
}

function enableFieldsForFunds() {
    const itemCostHint = document.getElementById('item_cost_hint');
    const quantityHint = document.getElementById('quantity_hint');
    
    itemCostHint.textContent = 'Donated value per instance';
    quantityHint.textContent = 'Number of fund instances';
}

function resetFormFields() {
    currentCategoryType = null;
    const donationTypeInput = document.getElementById('new_donation_type');
    const categoryHint = document.getElementById('category_hint');
    const uomSelect = document.getElementById('new_uom_code');
    const uomHidden = document.getElementById('new_uom_code_hidden');
    const uomHint = document.getElementById('selected_uom');
    
    donationTypeInput.value = '';
    categoryHint.textContent = 'Auto-set';
    
    uomSelect.value = '';
    uomHidden.value = '';
    uomHint.textContent = '—';
    
    document.getElementById('item_cost_hint').textContent = 'Cost per unit';
    document.getElementById('quantity_hint').textContent = 'Default: 1.00';
}

// Add item button click handler with GOODS/FUNDS validation
document.getElementById('addItemBtn').addEventListener('click', function() {
    const itemSelect = document.getElementById('new_item_id');
    const donationTypeInput = document.getElementById('new_donation_type');
    const quantityInput = document.getElementById('new_quantity');
    const itemCostInput = document.getElementById('new_item_cost');
    const uomSelect = document.getElementById('new_uom_code');
    const uomHidden = document.getElementById('new_uom_code_hidden');
    const locationInput = document.getElementById('new_location_name');
    const commentsInput = document.getElementById('new_item_comments');
    
    if (!itemSelect.value) {
        alert('Please select an item');
        itemSelect.focus();
        return;
    }
    
    if (!currentCategoryType) {
        alert('Please wait for item category to load');
        return;
    }
    
    // Check for duplicate items
    const existingItem = donationItems.find(item => item.item_id == itemSelect.value);
    if (existingItem) {
        alert('This item has already been added to the donation. Each item can only be added once.');
        itemSelect.focus();
        return;
    }
    
    const qty = parseFloat(quantityInput.value) || 0;
    const itemCost = window.DRIMS && window.DRIMS.money ? window.DRIMS.money.parse(itemCostInput.value) : parseFloat(itemCostInput.value.replace(/[$,]/g, ''));
    
    if (qty < 0) {
        alert('Quantity must be >= 0');
        quantityInput.focus();
        return;
    }
    
    if (itemCost === null || isNaN(itemCost) || itemCost < 0) {
        alert('Item cost must be >= 0');
        itemCostInput.focus();
        return;
    }
    
    if (!uomHidden.value) {
        alert('Please select an item with a valid unit of measure');
        itemSelect.focus();
        return;
    }
    
    if (!locationInput.value.trim()) {
        alert('Please enter a location');
        locationInput.focus();
        return;
    }
    
    const selectedItemOption = itemSelect.options[itemSelect.selectedIndex];
    const selectedUomOption = uomSelect.options[uomSelect.selectedIndex];
    
    const item = {
        id: ++itemCounter,
        is_existing: false,
        item_id: itemSelect.value,
        item_name: selectedItemOption.getAttribute('data-name'),
        donation_type: currentCategoryType,
        quantity: qty,
        item_cost: itemCost,
        uom_code: uomHidden.value,
        uom_desc: selectedUomOption ? selectedUomOption.getAttribute('data-desc') : uomHidden.value,
        location_name: locationInput.value.trim().toUpperCase(),
        comments: commentsInput.value.trim().toUpperCase()
    };
    
    donationItems.push(item);
    updateItemsTable();
    
    itemSelect.value = '';
    resetFormFields();
    quantityInput.value = '1.00';
    itemCostInput.value = '';
    locationInput.value = 'DONATION RECEIVED';
    commentsInput.value = '';
    
    itemSelect.focus();
});

// Event delegation for remove item buttons
document.addEventListener('click', function(e) {
    const removeBtn = e.target.closest('[data-action="remove-donation-item"]');
    if (removeBtn) {
        const itemId = parseInt(removeBtn.dataset.itemId);
        const index = donationItems.findIndex(item => item.id === itemId);
        if (index > -1) {
            if (confirm('Remove this item from the donation?')) {
                donationItems.splice(index, 1);
                updateItemsTable();
            }
        }
    }
});

function updateItemsTable() {
    const tableContainer = document.getElementById('itemsTableContainer');
    const hiddenContainer = document.getElementById('itemsContainer');
    const noItemsMsg = document.getElementById('noItemsMessage');
    const itemCountSpan = document.getElementById('itemCount');
    
    itemCountSpan.textContent = donationItems.length;
    
    if (donationItems.length === 0) {
        tableContainer.innerHTML = '';
        hiddenContainer.innerHTML = '';
        noItemsMsg.classList.remove('d-none');
        noItemsMsg.classList.add('d-block');
    } else {
        noItemsMsg.classList.remove('d-block');
        noItemsMsg.classList.add('d-none');
        
        let tableHtml = `
            <div class="table-responsive">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th scope="col">Item</th>
                            <th scope="col">Type</th>
                            <th scope="col" class="text-end">Quantity</th>
                            <th scope="col" class="text-end">Item Cost</th>
                            <th scope="col">Comments</th>
                            <th scope="col" class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        let totalItemCost = 0;
        let hiddenHtml = '';
        
        donationItems.forEach((item, index) => {
            const lineTotal = item.quantity * item.item_cost;
            totalItemCost += lineTotal;
            const existingBadge = item.is_existing ? '<span class="badge bg-secondary ms-1">Existing</span>' : '<span class="badge bg-success ms-1">New</span>';
            
            tableHtml += `
                <tr>
                    <td>
                        <strong>${item.item_name}</strong>${existingBadge}
                        <br><small class="text-muted">${item.uom_desc} @ ${item.location_name}</small>
                    </td>
                    <td><span class="badge ${item.donation_type === 'FUNDS' ? 'bg-success' : 'bg-primary'}">${item.donation_type}</span></td>
                    <td class="text-end">${item.quantity.toFixed(2)}</td>
                    <td class="text-end">$${item.item_cost.toFixed(2)}</td>
                    <td>${item.comments || '—'}</td>
                    <td class="text-end">
                        <button type="button" class="btn btn-sm btn-outline-danger" data-action="remove-donation-item" data-item-id="${item.id}" title="Remove item">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            hiddenHtml += `
                <input type="hidden" name="item_id_${index + 1}" value="${item.item_id}">
                <input type="hidden" name="donation_type_${index + 1}" value="${item.donation_type}">
                <input type="hidden" name="quantity_${index + 1}" value="${item.quantity}">
                <input type="hidden" name="item_cost_${index + 1}" value="${item.item_cost}">
                <input type="hidden" name="uom_id_${index + 1}" value="${item.uom_code}">
                <input type="hidden" name="location_name_${index + 1}" value="${item.location_name}">
                <input type="hidden" name="item_comments_${index + 1}" value="${item.comments || ''}">
                <input type="hidden" name="is_existing_${index + 1}" value="${item.is_existing ? 'true' : 'false'}">
            `;
        });
        
        tableHtml += `
                    </tbody>
                    <tfoot>
                        <tr class="table-light">
                            <td colspan="3" class="text-end"><strong>Total Donation Value:</strong></td>
                            <td class="text-end"><strong>$${totalItemCost.toFixed(2)}</strong></td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        `;
        
        tableContainer.innerHTML = tableHtml;
        hiddenContainer.innerHTML = hiddenHtml;
        
        // Update the read-only total item cost field
        document.getElementById('tot_item_cost').value = totalItemCost.toFixed(2);
    }
}
</script>
{% endblock %}

{% extends 'base.html' %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/relief-requests-ui.css') }}">
{% endblock %}

{% block title %}Accept Donation{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="page-header mb-0">
            <div class="page-title">
                <i class="bi bi-gift page-title-icon"></i>
                <h1 class="page-title-text">Accept New Donation</h1>
            </div>
        </div>
        <a href="{{ url_for('donations.list_donations') }}" class="btn-relief-secondary">
            <i class="bi bi-arrow-left"></i> Back to List
        </a>
    </div>

    <!-- Form Card -->
    <div class="row">
        <div class="col-lg-10 col-xl-8">
            <div class="card">
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('donations.create_donation') }}" novalidate>
                        <!-- Donation Information Section -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> Donation Information
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="donor_id" class="form-label">
                                        Donor <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="donor_id" name="donor_id" required>
                                        <option value="">-- Select Donor --</option>
                                        {% for donor in donors %}
                                        <option value="{{ donor.donor_id }}" {% if form_data and form_data.get('donor_id')|string == donor.donor_id|string %}selected{% endif %}>
                                            {{ donor.donor_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="event_id" class="form-label">
                                        Event <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="event_id" name="event_id" required>
                                        <option value="">-- Select Event --</option>
                                        {% for event in events %}
                                        <option value="{{ event.event_id }}" {% if form_data and form_data.get('event_id')|string == event.event_id|string %}selected{% endif %}>
                                            {{ event.event_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Description and Date Section -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-file-text"></i> Description and Details
                            </h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="donation_desc" class="form-label">
                                        Donation Description <span class="text-danger">*</span>
                                    </label>
                                    <textarea class="form-control" 
                                              id="donation_desc" 
                                              name="donation_desc" 
                                              rows="3" 
                                              required 
                                              placeholder="Describe the donation contents and source..."
                                              style="text-transform: uppercase;">{{ form_data.get('donation_desc') if form_data else '' }}</textarea>
                                    <small class="form-text text-muted">Auto-converted to uppercase</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="received_date" class="form-label">
                                        Received Date <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" 
                                           class="form-control" 
                                           id="received_date" 
                                           name="received_date" 
                                           max="{{ today }}" 
                                           value="{{ form_data.get('received_date') if form_data else today }}"
                                           required>
                                    <small class="form-text text-muted">Cannot be a future date</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="custodian_id" class="form-label">
                                        Custodian <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="custodian_id" name="custodian_id" required>
                                        <option value="">-- Select Custodian --</option>
                                        {% for custodian in custodians %}
                                        <option value="{{ custodian.custodian_id }}" {% if form_data and form_data.get('custodian_id')|string == custodian.custodian_id|string %}selected{% endif %}>
                                            {{ custodian.custodian_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Comments Section -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-chat-left-text"></i> Additional Comments
                            </h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="comments_text" class="form-label">
                                        Comments
                                    </label>
                                    <textarea class="form-control" 
                                              id="comments_text" 
                                              name="comments_text" 
                                              rows="2"
                                              placeholder="Optional comments about this donation..."
                                              style="text-transform: uppercase;">{{ form_data.get('comments_text') if form_data else '' }}</textarea>
                                    <small class="form-text text-muted">Auto-converted to uppercase</small>
                                </div>
                            </div>
                        </div>

                        <!-- Donation Items Section -->
                        <div class="mb-4">
                            <div class="drims-card">
                                <h5 class="mb-3"><i class="bi bi-plus-circle"></i> Add Donation Item</h5>
                                <div id="addItemForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="new_item_id" class="form-label">Item *</label>
                                            <select class="form-select" id="new_item_id">
                                                <option value="">Select item...</option>
                                                {% for item in items %}
                                                <option value="{{ item.item_id }}" data-name="{{ item.item_name }}" data-uom="{{ item.default_uom_code }}">
                                                    {{ item.item_name }} ({{ item.sku_code }})
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="new_quantity" class="form-label">Quantity *</label>
                                            <input type="number" class="form-control" id="new_quantity" step="0.01" min="0.01" placeholder="0.00">
                                            <small class="text-muted" id="uom_hint">Unit: <span id="selected_uom">—</span></small>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="new_uom_code" class="form-label">UOM *</label>
                                            <select class="form-select" id="new_uom_code">
                                                <option value="">Select...</option>
                                                {% for uom in uoms %}
                                                <option value="{{ uom.uom_code }}" data-desc="{{ uom.uom_desc }}">
                                                    {{ uom.uom_desc }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="new_item_comments" class="form-label">Item Comments</label>
                                            <input type="text" class="form-control" id="new_item_comments" placeholder="Optional comments about this item..." style="text-transform: uppercase;">
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-goj" id="addItemBtn">
                                        <i class="bi bi-plus-circle"></i> Add Item to Donation
                                    </button>
                                </div>
                            </div>

                            <div class="drims-card mt-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Current Items (<span id="itemCount">0</span>)</h5>
                                </div>

                                <div id="itemsTableContainer"></div>
                                
                                <div id="noItemsMessage" class="text-center py-4">
                                    <i class="bi bi-inbox" style="font-size: 3rem; color: #dee2e6;"></i>
                                    <p class="text-muted mt-2 mb-0">No items added yet. Use the form above to add items to this donation.</p>
                                </div>

                                <div id="itemsContainer" style="display: none;">
                                    <!-- Hidden inputs for form submission -->
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                            <a href="{{ url_for('donations.list_donations') }}" class="btn-relief-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn-relief-primary" id="submitBtn">
                                <i class="bi bi-check-circle"></i> Accept Donation
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let itemCounter = 0;
const donationItems = [];

// Update UOM hint when item is selected
document.getElementById('new_item_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const uomCode = selectedOption.getAttribute('data-uom');
    const uomHint = document.getElementById('selected_uom');
    if (uomCode) {
        uomHint.textContent = uomCode;
    } else {
        uomHint.textContent = '—';
    }
});

// Add item button click handler
document.getElementById('addItemBtn').addEventListener('click', function() {
    const itemSelect = document.getElementById('new_item_id');
    const quantityInput = document.getElementById('new_quantity');
    const uomSelect = document.getElementById('new_uom_code');
    const commentsInput = document.getElementById('new_item_comments');
    
    // Validate
    if (!itemSelect.value) {
        alert('Please select an item');
        itemSelect.focus();
        return;
    }
    if (!quantityInput.value || parseFloat(quantityInput.value) <= 0) {
        alert('Please enter a valid quantity greater than 0');
        quantityInput.focus();
        return;
    }
    if (!uomSelect.value) {
        alert('Please select a unit of measure');
        uomSelect.focus();
        return;
    }
    
    // Get item details
    const selectedItemOption = itemSelect.options[itemSelect.selectedIndex];
    const selectedUomOption = uomSelect.options[uomSelect.selectedIndex];
    
    const item = {
        id: ++itemCounter,
        item_id: itemSelect.value,
        item_name: selectedItemOption.getAttribute('data-name'),
        quantity: parseFloat(quantityInput.value),
        uom_code: uomSelect.value,
        uom_desc: selectedUomOption.getAttribute('data-desc'),
        comments: commentsInput.value.trim().toUpperCase()
    };
    
    donationItems.push(item);
    updateItemsTable();
    
    // Clear form
    itemSelect.value = '';
    quantityInput.value = '';
    uomSelect.value = '';
    commentsInput.value = '';
    document.getElementById('selected_uom').textContent = '—';
    
    itemSelect.focus();
});

function removeItem(itemId) {
    const index = donationItems.findIndex(item => item.id === itemId);
    if (index > -1) {
        if (confirm('Remove this item from the donation?')) {
            donationItems.splice(index, 1);
            updateItemsTable();
        }
    }
}

function updateItemsTable() {
    const tableContainer = document.getElementById('itemsTableContainer');
    const hiddenContainer = document.getElementById('itemsContainer');
    const noItemsMsg = document.getElementById('noItemsMessage');
    const itemCountSpan = document.getElementById('itemCount');
    
    itemCountSpan.textContent = donationItems.length;
    
    if (donationItems.length === 0) {
        tableContainer.innerHTML = '';
        hiddenContainer.innerHTML = '';
        noItemsMsg.style.display = 'block';
    } else {
        noItemsMsg.style.display = 'none';
        
        // Build table HTML
        let tableHtml = `
            <div class="table-responsive">
                <table class="table drims-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th class="text-end">Quantity</th>
                            <th>Comments</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        donationItems.forEach(item => {
            tableHtml += `
                <tr>
                    <td>${item.item_name}</td>
                    <td class="text-end">
                        <strong>${item.quantity.toFixed(2)}</strong>
                        ${item.uom_desc}
                    </td>
                    <td>
                        ${item.comments ? item.comments : '<span class="text-muted">—</span>'}
                    </td>
                    <td class="text-end">
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(${item.id})">
                            <i class="bi bi-trash"></i> Remove
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tableHtml += `
                    </tbody>
                </table>
            </div>
        `;
        
        tableContainer.innerHTML = tableHtml;
        
        // Build hidden inputs for form submission
        let hiddenHtml = '';
        donationItems.forEach((item, index) => {
            const num = index + 1;
            hiddenHtml += `
                <input type="hidden" name="item_id_${num}" value="${item.item_id}">
                <input type="hidden" name="quantity_${num}" value="${item.quantity}">
                <input type="hidden" name="uom_id_${num}" value="${item.uom_code}">
                <input type="hidden" name="item_comments_${num}" value="${item.comments}">
            `;
        });
        
        hiddenContainer.innerHTML = hiddenHtml;
    }
}

// Form submission validation
document.querySelector('form').addEventListener('submit', function(e) {
    if (donationItems.length === 0) {
        e.preventDefault();
        alert('Please add at least one donation item before submitting.');
        return false;
    }
});
</script>
{% endblock %}

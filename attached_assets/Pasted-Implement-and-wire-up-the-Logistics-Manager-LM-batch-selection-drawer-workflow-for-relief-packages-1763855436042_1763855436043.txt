Implement and wire up the Logistics Manager (LM) batch selection drawer workflow for relief packages in the Disaster Management/Relief Inventory Management System, without breaking any existing code, logic, workflows, behaviour, UI, or database schema, and without regressing any of the previously implemented security fixes.

Context

This drawer is opened by a Logistics Manager (LM) for a given item in a relief package.

The drawer is used after a Logistics Officer (LO) has submitted the package for approval, so the LM can review and adjust which batches are allocated for that item.

Use the existing database tables (e.g. reliefpkg_item, itembatch, inventory / warehouse tables) and existing relationships. Do not modify any schema.

Functional Requirements – LM Drawer Batch Logic

For a given reliefpkg_id and item_id:

Allocated Batches – Set A

Query all existing allocations for this package and item.

Set A = all (inventory_id, batch_id) pairs where this package already has an allocation for this item.

Concretely: rows from reliefpkg_item (or the equivalent allocation table) filtered by:

reliefpkg_id = <current package>

item_id = <current item>

These must always be shown in the LM drawer, even if:

available for that batch is 0 or less.

For each allocated batch, show:

Warehouse (if applicable)

Batch identifier

Expiry date (if tracked)

Allocated quantity

Available quantity (even if 0)

Any other existing fields that are already used in the UI.

Available Batches – Set B

Query all itembatch records for this item_id where there is still stock that can be allocated.

Compute:

available = usable_qty - reserved_qty

Set B = all (inventory_id, batch_id) where:

item_id = <current item>

available > 0

These are potential sources for adjustment (LM may move allocation from one batch to another, or increase/decrease allocations using these).

Union for Display – AllBatches

For each warehouse, conceptually define:

AllBatches = AllocatedBatches (Set A) ∪ AvailableBatches (Set B)

In the LM drawer UI, show the union of Set A and Set B, grouped or clearly labelled by warehouse if warehouses are part of the model.

Where a (inventory_id, batch_id) appears in both A and B, only show one consolidated row in the UI, combining:

Its allocated quantity (from A)

Its available quantity (from B calculation)

Do NOT Show Certain Batches

Exclude any batch from the drawer where:

available <= 0

AND the batch is not in Set A (i.e. the package has never used this batch).

In other words:

Batches with available <= 0 must only be displayed if they are already allocated to this package (in Set A).

Batches with available <= 0 and no allocation for this package should be completely hidden from the LM drawer.

Behaviour & UX

The LM must be able to:

See all currently allocated batches for the item.

See other available batches (with available > 0) they can reallocate from.

Adjust quantities in a way that respects:

Not allocating more than available in any batch.

Any existing business rules already enforced for the LO workflow.

Do not create new workflows; just extend/align the LM drawer behaviour with the existing fulfilment/packaging processes.

Preserve existing styling and general look-and-feel of the drawer (forms, tables, buttons, etc.).

Non-Breaking Constraints

When implementing this LM drawer logic:

Do NOT:

Change existing database tables, columns, constraints, triggers, or relationships.

Remove or alter existing routes/endpoints, business logic, or workflows.

Break any existing Logistics Officer, Logistics Manager, Warehouse, or Agency workflows.

Change field names that are already used by front-end code.

Only add or adjust queries and UI logic needed to support:

Set A (allocated batches)

Set B (available batches)

Their union and filtering rules as described above.

Security Requirements – Must Not Regress

All previously implemented security hardening must remain in place and unchanged. Do not remove, weaken, or bypass any of the following (this list is indicative, not exhaustive):

Content Security Policy (CSP) header.

Secure HTTP headers:

X-Content-Type-Options: nosniff

Referrer-Policy: strict-origin-when-cross-origin (or stricter)

Hardened TLS/SSL configuration:

No RSA key-exchange ciphers.

Only strong ECDHE/CHACHA20 suites with PFS.

No SHA-1 ciphers.

Cookie security:

Secure, HttpOnly, and appropriate SameSite on session/auth cookies.

Subresource Integrity (SRI) on all third-party CDN assets, plus crossorigin="anonymous".

Cache-control for sensitive/authenticated pages:

Cache-Control: no-store, no-cache, must-revalidate

Pragma: no-cache

Expires: 0

Password fields:

autocomplete="new-password" or autocomplete="off" as already fixed.

/static/ directory protections:

No directory listing; no information leakage.

Removed/sanitized info-leaking headers (e.g. Server, X-Powered-By, etc.).

No debug or detailed error pages in production:

Generic user-facing error pages only; details in logs.

Email address exposure mitigations:

Obfuscated or form-based contact instead of raw emails on public pages.

Rejection/ignoring of sensitive body parameters in query strings:

Sensitive data only processed from POST bodies.

Any new code for the LM drawer must respect and work within this security posture.

Expected Outcome

The LM drawer for an item in a relief package:

Shows all allocated batches for that item in the package (Set A), even where available <= 0.

Shows all additional available batches for that item (Set B) where available > 0.

Displays the union of these per warehouse, excluding any non-allocated batches with available <= 0.

No existing behaviour, workflows, or database structures are broken.

All previously implemented security fixes remain fully intact and effective.
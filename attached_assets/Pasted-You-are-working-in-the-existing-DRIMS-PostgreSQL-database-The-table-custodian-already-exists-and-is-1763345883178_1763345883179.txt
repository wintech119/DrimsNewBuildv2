You are working in the existing DRIMS PostgreSQL database.
The table custodian already exists and is referenced elsewhere in the schema.

Your task is to alter the existing custodian table so that it matches the target schema below, without breaking any foreign key references, constraints, or indexes.

1️⃣ Target Schema for custodian

Update the custodian table so that it matches exactly this definition:

create table custodian
(
    custodian_id integer not null generated by default as identity
        constraint pk_custodian primary key,
    
    custodian_name varchar(120) not null
        default 'OFFICE OF DISASTER PREPAREDNESS AND EMERGENCY MANAGEMENT (ODPEM)'
        -- custodian name must be uppercase and unique
        constraint c_custodian_1 check (custodian_name = upper(custodian_name))
        constraint uk_custodian_1 unique,
    
    address1_text varchar(255) not null,
    address2_text varchar(255),

    -- Indicate parish in which custodian is located
    parish_code char(2) not null
        constraint fk_custodian_parish references parish,

    contact_name varchar(50) not null
        -- Contact name must be in upper case.
        constraint c_custodian_3 check (contact_name = upper(contact_name)),

    phone_no varchar(20) not null,
    email_text varchar(100),

    create_by_id varchar(20) not null,
    create_dtime timestamp(0) without time zone not null,
    update_by_id varchar(20) not null,
    update_dtime timestamp(0) without time zone not null,
    version_nbr integer not null
);

2️⃣ Requirements & Constraints

When generating the migration:

Do NOT break foreign keys or references

Other tables may reference custodian.custodian_id via FKs.

After the migration, all such FKs must still exist and remain valid.

Preserve / (Re)create named constraints

Primary key: pk_custodian on custodian_id

Unique constraint: uk_custodian_1 on custodian_name

Check constraints:

c_custodian_1 → custodian_name = upper(custodian_name)

c_custodian_3 → contact_name = upper(contact_name)

Foreign key:

fk_custodian_parish → parish_code referencing parish (existing parish table)

Columns & types must match exactly

Add/alter columns as needed so that:

custodian_id is integer generated by default as identity not null

custodian_name is varchar(120) not null with the specified default, uppercase check, and unique constraint.

address1_text and address2_text are varchar(255) (address1 required, address2 optional).

parish_code is char(2) not null with FK to parish.

contact_name is varchar(50) not null with uppercase check.

phone_no is varchar(20) not null.

email_text is varchar(100) (nullable).

create_by_id, update_by_id are varchar(20) not null.

create_dtime, update_dtime are timestamp(0) without time zone not null.

version_nbr is integer not null.

Migration must be safe and ordered

Prefer ALTER TABLE to adjust columns, constraints, and defaults in place.

Only consider dropping/recreating the table as a last resort, and only if:

You first capture all foreign key constraints referencing custodian.

Drop them temporarily.

Recreate custodian with the new schema.

Recreate all FKs with the same names and behaviours.

Do not lose data unless explicitly safe

If there is existing data, you must:

Preserve data in custodian where compatible.

For new constraints (e.g., uppercase checks), either:

Normalize existing data (e.g., update custodian_name and contact_name to uppercase), or

Document and apply appropriate data-cleanup steps before applying the constraint.

If a column type/length is being reduced, ensure truncation or rejection is handled carefully.

Indexes

Preserve or re-create any useful indexes on custodian (e.g. on custodian_name or parish_code).

If an index is implicitly created by unique/PK constraints, avoid duplicating redundant explicit indexes.

Keep existing index names if they follow DRIMS conventions.

3️⃣ What to Generate

Produce a single SQL migration script that:

Introspects or assumes the current structure of custodian.

Uses ALTER TABLE (and only if necessary, a drop-and-recreate approach) to bring it in line with the target schema.

Ensures:

All constraint names match those in the target schema.

All foreign keys from other tables to custodian.custodian_id remain valid.

The FK fk_custodian_parish is present and correct.

Includes comments separating logical phases, e.g.:

-- 1. Normalize existing data (uppercase names, etc.)
-- 2. Adjust columns (add/alter)
-- 3. Add/adjust constraints (PK, UNIQUE, CHECK, FK)
-- 4. Recreate indexes if needed
-- 5. Verify structure


Is idempotent enough for a one-time migration in a controlled environment (it doesn’t need to be re-runnable, but must complete cleanly on a schema where custodian is in its current state).

4️⃣ Scope Limits

Do not modify any other tables beyond:

Temporarily dropping and re-adding FKs that reference custodian (if absolutely required).

Do not change application code in this prompt (SQL migration only).

Use this as the complete specification for generating the migration script to alter the custodian table sa
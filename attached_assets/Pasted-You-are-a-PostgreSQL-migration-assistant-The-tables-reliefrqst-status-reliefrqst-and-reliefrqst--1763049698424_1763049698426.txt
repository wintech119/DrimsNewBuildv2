You are a PostgreSQL migration assistant.

The tables reliefrqst_status, reliefrqst, and reliefrqst_item already exist in the database.

Your task is to alter the existing tables so that their structure matches the target schema below.

Very important requirements:

Do NOT drop or recreate any of these tables.

Do NOT truncate or delete existing data.

Use ALTER TABLE, CREATE INDEX IF NOT EXISTS, and INSERT ... ON CONFLICT where appropriate.

The migration must be idempotent: safe to run multiple times.

Ensure all primary keys, foreign keys, check constraints, NOT NULLs, defaults, and indexes match the target design.

Fix or add constraints as needed to enforce the same business rules expressed in this schema.

Seed the reliefrqst_status lookup with the values shown, using ON CONFLICT (status_code) DO NOTHING.

Use the following DDL as the canonical target structure:

-- Stores details of statuses for relief requests
CREATE TABLE reliefrqst_status
(
  status_code      SMALLINT    NOT NULL
                                CONSTRAINT pk_reliefrqst_status PRIMARY KEY,
  status_desc      VARCHAR(20) NOT NULL,
  reason_rqrd_flag BOOLEAN     NOT NULL,
  is_active_flag   BOOLEAN     NOT NULL DEFAULT TRUE
);

INSERT INTO reliefrqst_status (status_code, status_desc, reason_rqrd_flag, is_active_flag) VALUES
  (0, 'DRAFT',              FALSE, TRUE),
  (1, 'AWAITING APPROVAL',  FALSE, TRUE),
  (2, 'CANCELLED',          FALSE, TRUE),
  (3, 'SUBMITTED',          FALSE, TRUE),
  (4, 'DENIED',             TRUE,  TRUE),
  (5, 'PART FILLED',        FALSE, TRUE),
  (6, 'CLOSED',             TRUE,  TRUE),
  (7, 'FILLED',             FALSE, TRUE),
  (8, 'INELIGIBLE',         TRUE,  TRUE)
ON CONFLICT (status_code) DO NOTHING;

-- Requests for relief submitted by agencies/shelters
CREATE TABLE reliefrqst
(
  reliefrqst_id      INTEGER  NOT NULL GENERATED BY DEFAULT AS IDENTITY
                               CONSTRAINT pk_reliefrqst PRIMARY KEY,

  agency_id          INTEGER  NOT NULL
                               CONSTRAINT fk_reliefrqst_agency
                               REFERENCES agency(agency_id),

  request_date       DATE     NOT NULL
                               CONSTRAINT c_reliefrqst_1
                               CHECK (request_date <= CURRENT_DATE),

  -- Randomly generated reference/tracking number for request
  tracking_no        VARCHAR(7) NOT NULL,

  -- Optional event for which the request is being made
  eligible_event_id  INTEGER
                               CONSTRAINT fk_reliefrqst_event
                               REFERENCES event(event_id),

  urgency_ind        CHAR(1)   NOT NULL
                               -- L=Low, M=Medium, H=High, C=Critical
                               CONSTRAINT c_reliefrqst_2
                               CHECK (urgency_ind IN ('L','M','H','C')),

  -- Optional notes related to request and review
  rqst_notes_text    TEXT,
  review_notes_text  TEXT,

  status_code        SMALLINT  NOT NULL DEFAULT 0
                               CONSTRAINT fk_reliefrqst_reliefrqst_status
                               REFERENCES reliefrqst_status(status_code),

  -- See relief status table for rules regarding status code and reason
  status_reason_desc VARCHAR(255)
                               CONSTRAINT c_reliefrqst_3
                               CHECK (
                                 (status_reason_desc IS NOT NULL)
                                 OR (status_reason_desc IS NULL AND status_code NOT IN (4,6,8))
                               ),

  -- Creates/Cancels request
  create_by_id       VARCHAR(20) NOT NULL,
  create_dtime       TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,

  -- Submits/Cancels request. Cancellation can be done by creator/reviewer
  review_by_id       VARCHAR(20)
                               CONSTRAINT c_reliefrqst_4a
                               CHECK (
                                 (review_by_id IS NULL AND status_code < 2)
                                 OR (review_by_id IS NOT NULL AND status_code >= 2)
                               ),
  review_dtime       TIMESTAMP(0) WITHOUT TIME ZONE
                               CONSTRAINT c_reliefrqst_4b
                               CHECK (
                                 (review_by_id IS NULL AND review_dtime IS NULL)
                                 OR (review_by_id IS NOT NULL AND review_dtime IS NOT NULL)
                               ),

  -- Actions request - Fill, Part fill, Closes
  action_by_id       VARCHAR(20)
                               CONSTRAINT c_reliefrqst_5a
                               CHECK (
                                 (action_by_id IS NULL AND status_code < 4)
                                 OR (action_by_id IS NOT NULL AND status_code >= 4)
                               ),
  action_dtime       TIMESTAMP(0) WITHOUT TIME ZONE
                               CONSTRAINT c_reliefrqst_5b
                               CHECK (
                                 (action_by_id IS NULL AND action_dtime IS NULL)
                                 OR (action_by_id IS NOT NULL AND action_dtime IS NOT NULL)
                               ),

  version_nbr        INTEGER NOT NULL
);

CREATE INDEX dk_reliefrqst_1 ON reliefrqst(agency_id, request_date);
CREATE INDEX dk_reliefrqst_2 ON reliefrqst(request_date, status_code);
CREATE INDEX dk_reliefrqst_3 ON reliefrqst(status_code, urgency_ind);

-- Items requested in request for relief
CREATE TABLE reliefrqst_item
(
  reliefrqst_id       INTEGER NOT NULL
                               CONSTRAINT fk_reliefrqst_item_reliefrqst
                               REFERENCES reliefrqst(reliefrqst_id),

  item_id             INTEGER NOT NULL
                               CONSTRAINT fk_reliefrqst_item_item
                               REFERENCES item(item_id),

  request_qty         DECIMAL(12,2) NOT NULL
                               CONSTRAINT c_reliefrqst_item_1
                               CHECK (request_qty > 0.00),

  issue_qty           DECIMAL(12,2) NOT NULL
                               CONSTRAINT c_reliefrqst_item_2a
                               CHECK (
                                 (status_code IN ('R','U','W','D') AND issue_qty = 0)
                                 OR (status_code IN ('P','L') AND issue_qty < request_qty)
                                 OR (status_code IN ('F') AND issue_qty = request_qty)
                               ),

  urgency_ind         CHAR(1) NOT NULL
                               CONSTRAINT c_reliefrqst_item_3
                               CHECK (urgency_ind IN ('L','M','H','C')),

  -- Reason for requested item is required if urgency is above medium
  rqst_reason_desc    VARCHAR(255)
                               CONSTRAINT c_reliefrqst_item_4
                               CHECK (
                                 (rqst_reason_desc IS NOT NULL)
                                 OR (rqst_reason_desc IS NULL AND urgency_ind IN ('L','M'))
                               ),

  required_by_date    DATE
                               CONSTRAINT c_reliefrqst_item_5
                               CHECK (
                                 (required_by_date IS NOT NULL)
                                 OR (required_by_date IS NULL AND urgency_ind IN ('L','M'))
                               ),

  status_code         CHAR(1) NOT NULL
                               -- R=Requested, U=Unavailable, W=Waiting availability,
                               -- D=Denied, P=Partly filled, L=Limit allowed, F=Filled
                               CONSTRAINT c_reliefrqst_item_6a
                               CHECK (status_code IN ('R','U','W','D','P','L','F')),

  -- Reason is required where item requested is denied/limited by ODPEM
  status_reason_desc  VARCHAR(255)
                               CONSTRAINT c_reliefrqst_item_6b
                               CHECK (
                                 (status_reason_desc IS NOT NULL)
                                 OR (status_reason_desc IS NULL AND status_code NOT IN ('D','L'))
                               ),

  action_by_id        VARCHAR(20)
                               CONSTRAINT c_reliefrqst_item_7
                               CHECK (
                                 (action_by_id IS NULL AND status_code = 'R')
                                 OR (action_by_id IS NOT NULL AND status_code <> 'R')
                               ),

  action_dtime        TIMESTAMP(0) WITHOUT TIME ZONE
                               CONSTRAINT c_reliefrqst_item_8
                               CHECK (
                                 (action_by_id IS NULL AND action_dtime IS NULL)
                                 OR (action_by_id IS NOT NULL AND action_dtime IS NOT NULL)
                               ),

  version_nbr         INTEGER NOT NULL,

  CONSTRAINT pk_reliefrqst_item PRIMARY KEY (reliefrqst_id, item_id)
);

CREATE INDEX dk_reliefrqst_item_2 ON reliefrqst_item(item_id, urgency_ind);


Generate and run a single SQL migration script that:

Uses ALTER TABLE to:

Add any missing columns.

Adjust data types where needed.

Add or fix primary keys, foreign keys, and check constraints to match the above.

Uses CREATE INDEX IF NOT EXISTS to ensure the indexes exist.

Uses INSERT ... ON CONFLICT DO NOTHING to seed reliefrqst_status.

Is safe to run multiple times and does not destroy or overwrite existing data.